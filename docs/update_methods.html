<!doctype html>
<html
    lang="en"
    class="light sidebar-visible"
    dir="ltr"
>
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8" />
        <title>Update Methods - The Azle Book</title>

        <!-- Custom HTML head -->

        <meta
            name="description"
            content=""
        />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />
        <meta
            name="theme-color"
            content="#ffffff"
        />

        <link
            rel="icon"
            href="favicon.svg"
        />
        <link
            rel="shortcut icon"
            href="favicon.png"
        />
        <link
            rel="stylesheet"
            href="css/variables.css"
        />
        <link
            rel="stylesheet"
            href="css/general.css"
        />
        <link
            rel="stylesheet"
            href="css/chrome.css"
        />
        <link
            rel="stylesheet"
            href="css/print.css"
            media="print"
        />

        <!-- Fonts -->
        <link
            rel="stylesheet"
            href="FontAwesome/css/font-awesome.css"
        />
        <link
            rel="stylesheet"
            href="fonts/fonts.css"
        />

        <!-- Highlight.js Stylesheets -->
        <link
            rel="stylesheet"
            href="highlight.css"
        />
        <link
            rel="stylesheet"
            href="tomorrow-night.css"
        />
        <link
            rel="stylesheet"
            href="ayu-highlight.css"
        />

        <!-- Custom theme stylesheets -->

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = '';
            var default_theme = window.matchMedia(
                '(prefers-color-scheme: dark)'
            ).matches
                ? 'navy'
                : 'light';
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
        <div id="body-container">
            <!-- Work around some values being stored in localStorage wrapped in quotes -->
            <script>
                try {
                    var theme = localStorage.getItem('mdbook-theme');
                    var sidebar = localStorage.getItem('mdbook-sidebar');

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            'mdbook-theme',
                            theme.slice(1, theme.length - 1)
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            'mdbook-sidebar',
                            sidebar.slice(1, sidebar.length - 1)
                        );
                    }
                } catch (e) {}
            </script>

            <!-- Set the theme before any content is loaded, prevents flash -->
            <script>
                var theme;
                try {
                    theme = localStorage.getItem('mdbook-theme');
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                const html = document.documentElement;
                html.classList.remove('light');
                html.classList.add(theme);
                html.classList.add('js');
            </script>

            <input
                type="checkbox"
                id="sidebar-toggle-anchor"
                class="hidden"
            />

            <!-- Hide / unhide sidebar before it is displayed -->
            <script>
                var sidebar = null;
                var sidebar_toggle = document.getElementById(
                    'sidebar-toggle-anchor'
                );
                if (document.body.clientWidth >= 1080) {
                    try {
                        sidebar = localStorage.getItem('mdbook-sidebar');
                    } catch (e) {}
                    sidebar = sidebar || 'visible';
                } else {
                    sidebar = 'hidden';
                }
                sidebar_toggle.checked = sidebar === 'visible';
                html.classList.remove('sidebar-visible');
                html.classList.add('sidebar-' + sidebar);
            </script>

            <nav
                id="sidebar"
                class="sidebar"
                aria-label="Table of contents"
            >
                <!-- populated by js -->
                <mdbook-sidebar-scrollbox
                    class="sidebar-scrollbox"
                ></mdbook-sidebar-scrollbox>
                <noscript>
                    <iframe
                        class="sidebar-iframe-outer"
                        src="toc.html"
                    ></iframe>
                </noscript>
                <div
                    id="sidebar-resize-handle"
                    class="sidebar-resize-handle"
                >
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <div
                id="page-wrapper"
                class="page-wrapper"
            >
                <div class="page">
                    <div id="menu-bar-hover-placeholder"></div>
                    <div
                        id="menu-bar"
                        class="menu-bar sticky"
                    >
                        <div class="left-buttons">
                            <label
                                id="sidebar-toggle"
                                class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar"
                            >
                                <i class="fa fa-bars"></i>
                            </label>
                            <button
                                id="theme-toggle"
                                class="icon-button"
                                type="button"
                                title="Change theme"
                                aria-label="Change theme"
                                aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list"
                            >
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul
                                id="theme-list"
                                class="theme-popup"
                                aria-label="Themes"
                                role="menu"
                            >
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="light"
                                    >
                                        Light
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="rust"
                                    >
                                        Rust
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="coal"
                                    >
                                        Coal
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="navy"
                                    >
                                        Navy
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="ayu"
                                    >
                                        Ayu
                                    </button>
                                </li>
                            </ul>
                            <button
                                id="search-toggle"
                                class="icon-button"
                                type="button"
                                title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false"
                                aria-keyshortcuts="S"
                                aria-controls="searchbar"
                            >
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                        <h1 class="menu-title">The Azle Book</h1>

                        <div class="right-buttons">
                            <a
                                href="print.html"
                                title="Print this book"
                                aria-label="Print this book"
                            >
                                <i
                                    id="print-button"
                                    class="fa fa-print"
                                ></i>
                            </a>
                        </div>
                    </div>

                    <div
                        id="search-wrapper"
                        class="hidden"
                    >
                        <form
                            id="searchbar-outer"
                            class="searchbar-outer"
                        >
                            <input
                                type="search"
                                id="searchbar"
                                name="searchbar"
                                placeholder="Search this book ..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header"
                            />
                        </form>
                        <div
                            id="searchresults-outer"
                            class="searchresults-outer hidden"
                        >
                            <div
                                id="searchresults-header"
                                class="searchresults-header"
                            ></div>
                            <ul id="searchresults"></ul>
                        </div>
                    </div>

                    <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                    <script>
                        document
                            .getElementById('sidebar-toggle')
                            .setAttribute(
                                'aria-expanded',
                                sidebar === 'visible'
                            );
                        document
                            .getElementById('sidebar')
                            .setAttribute('aria-hidden', sidebar !== 'visible');
                        Array.from(
                            document.querySelectorAll('#sidebar a')
                        ).forEach(function (link) {
                            link.setAttribute(
                                'tabIndex',
                                sidebar === 'visible' ? 0 : -1
                            );
                        });
                    </script>

                    <div
                        id="content"
                        class="content"
                    >
                        <main>
                            <h1 id="update-methods">
                                <a
                                    class="header"
                                    href="#update-methods"
                                    >Update Methods</a
                                >
                            </h1>
                            <h2 id="tldr">
                                <a
                                    class="header"
                                    href="#tldr"
                                    >TL;DR</a
                                >
                            </h2>
                            <ul>
                                <li>
                                    Created with the
                                    <code>update</code> function
                                </li>
                                <li>Read-write</li>
                                <li>Executed on many nodes</li>
                                <li>Consensus</li>
                                <li>Latency ~2-5 seconds</li>
                                <li>
                                    <a
                                        href="https://internetcomputer.org/docs/current/developer-docs/production/instruction-limits"
                                        >20 billion Wasm instruction limit</a
                                    >
                                </li>
                                <li>4 GiB heap limit</li>
                                <li>96 GiB stable memory limit</li>
                                <li>
                                    <a
                                        href="https://forum.dfinity.org/t/what-is-the-theroretical-number-for-txns-per-second-on-internet-computer-right-now/14039/6"
                                        >~900 updates per second per canister</a
                                    >
                                </li>
                            </ul>
                            <p>
                                Update methods are similar to query methods, but
                                state changes can be persisted. Here's an
                                example of a simple update method:
                            </p>
                            <pre><code class="language-typescript">import { Canister, nat64, update } from 'azle/experimental';

let counter = 0n;

export default Canister({
    increment: update([], nat64, () =&gt; {
        return counter++;
    })
});
</code></pre>
                            <p>
                                Calling <code>increment</code> will return the
                                current value of <code>counter</code> and then
                                increase its value by 1. Because
                                <code>counter</code> is a global variable, the
                                change will be persisted to the heap, and
                                subsequent query and update calls will have
                                access to the new <code>counter</code> value.
                            </p>
                            <p>
                                Because the Internet Computer (IC) persists
                                changes with certain fault tolerance guarantees,
                                update calls are executed on many nodes and go
                                through
                                <a
                                    href="https://internetcomputer.org/how-it-works/consensus/"
                                    >consensus</a
                                >. This leads to latencies of ~2-5 seconds per
                                update call.
                            </p>
                            <p>
                                Due to the latency and other expenses involved
                                with update methods, it is best to use them only
                                when necessary. Look at the following example:
                            </p>
                            <pre><code class="language-typescript">import { Canister, query, text, update, Void } from 'azle/experimental';

let message = '';

export default Canister({
    getMessage: query([], text, () =&gt; {
        return message;
    }),
    setMessage: update([text], Void, (newMessage) =&gt; {
        message = newMessage;
    })
});
</code></pre>
                            <p>
                                You'll notice that we use an update method,
                                <code>setMessage</code>, only to perform the
                                change to the global
                                <code>message</code> variable. We use
                                <code>getMessage</code>, a query method, to read
                                the message.
                            </p>
                            <p>
                                Keep in mind that the heap is limited to 4 GiB,
                                and thus there is an upper bound to global
                                variable storage capacity. You can imagine how a
                                simple database like the following would
                                eventually run out of memory with too many
                                entries:
                            </p>
                            <pre><code class="language-typescript">import {
    Canister,
    None,
    Opt,
    query,
    Some,
    text,
    update,
    Void
} from 'azle/experimental';

type Db = {
    [key: string]: string;
};

let db: Db = {};

export default Canister({
    get: query([text], Opt(text), (key) =&gt; {
        const value = db[key];
        return value !== undefined ? Some(value) : None;
    }),
    set: update([text, text], Void, (key, value) =&gt; {
        db[key] = value;
    })
});
</code></pre>
                            <p>
                                If you need more than 4 GiB of storage, consider
                                taking advantage of the 96 GiB of stable memory.
                                Stable structures like
                                <code>StableBTreeMap</code> give you a nice API
                                for interacting with stable memory. These data
                                structures will be
                                <a href="./stable_structures.html"
                                    >covered in more detail later</a
                                >. Here's a simple example:
                            </p>
                            <pre><code class="language-typescript">import {
    Canister,
    Opt,
    query,
    StableBTreeMap,
    text,
    update,
    Void
} from 'azle/experimental';

let db = StableBTreeMap&lt;text, text&gt;(0);

export default Canister({
    get: query([text], Opt(text), (key) =&gt; {
        return db.get(key);
    }),
    set: update([text, text], Void, (key, value) =&gt; {
        db.insert(key, value);
    })
});
</code></pre>
                            <p>
                                So far we have only seen how state changes can
                                be persisted. State changes can also be
                                discarded by implicit or explicit traps. A trap
                                is an immediate stop to execution with the
                                ability to provide a message to the execution
                                environment.
                            </p>
                            <p>
                                Traps can be useful for ensuring that multiple
                                operations are either all completed or all
                                disregarded, or in other words atomic. Keep in
                                mind that these guarantees do not hold once
                                cross-canister calls are introduced, but that's
                                a more advanced topic
                                <a href="./cross_canister.html">covered later</a
                                >.
                            </p>
                            <p>
                                Here's an example of how to trap and ensure
                                atomic changes to your database:
                            </p>
                            <pre><code class="language-typescript">import {
    Canister,
    ic,
    Opt,
    query,
    Record,
    StableBTreeMap,
    text,
    update,
    Vec,
    Void
} from 'azle/experimental';

const Entry = Record({
    key: text,
    value: text
});

let db = StableBTreeMap&lt;text, text&gt;(0);

export default Canister({
    get: query([text], Opt(text), (key) =&gt; {
        return db.get(key);
    }),
    set: update([text, text], Void, (key, value) =&gt; {
        db.insert(key, value);
    }),
    setMany: update([Vec(Entry)], Void, (entries) =&gt; {
        entries.forEach((entry) =&gt; {
            if (entry.key === 'trap') {
                ic.trap('explicit trap');
            }

            db.insert(entry.key, entry.value);
        });
    })
});
</code></pre>
                            <p>
                                In addition to <code>ic.trap</code>, an explicit
                                JavaScript <code>throw</code> or any unhandled
                                exception will also trap.
                            </p>
                            <p>
                                There is a limit to how much computation can be
                                done in a single call to an update method. The
                                current update call limit is
                                <a
                                    href="https://internetcomputer.org/docs/current/developer-docs/production/instruction-limits"
                                    >20 billion Wasm instructions</a
                                >. If we modify our database example, we can
                                introduce an update method that runs the risk of
                                reaching the limit:
                            </p>
                            <pre><code class="language-typescript">import {
    Canister,
    nat64,
    Opt,
    query,
    StableBTreeMap,
    text,
    update,
    Void
} from 'azle/experimental';

let db = StableBTreeMap&lt;text, text&gt;(0);

export default Canister({
    get: query([text], Opt(text), (key) =&gt; {
        return db.get(key);
    }),
    set: update([text, text], Void, (key, value) =&gt; {
        db.insert(key, value);
    }),
    setMany: update([nat64], Void, (numEntries) =&gt; {
        for (let i = 0; i &lt; numEntries; i++) {
            db.insert(i.toString(), i.toString());
        }
    })
});
</code></pre>
                            <p>
                                From the <code>dfx command line</code> you can
                                call <code>setMany</code> like this:
                            </p>
                            <pre><code class="language-bash">dfx canister call my_canister setMany '(10_000)'
</code></pre>
                            <p>
                                With an argument of <code>10_000</code>,
                                <code>setMany</code> will fail with an error
                                <code
                                    >...exceeded the instruction limit for
                                    single message execution</code
                                >.
                            </p>
                            <p>
                                In terms of update scalability, an individual
                                canister
                                <a
                                    href="https://forum.dfinity.org/t/what-is-the-theroretical-number-for-txns-per-second-on-internet-computer-right-now/14039/6"
                                    >likely has an upper bound of ~900 updates
                                    per second</a
                                >.
                            </p>
                        </main>

                        <nav
                            class="nav-wrapper"
                            aria-label="Page navigation"
                        >
                            <!-- Mobile navigation buttons -->
                            <a
                                rel="prev"
                                href="query_methods.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left"
                            >
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a
                                rel="next prefetch"
                                href="candid.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter"
                                aria-label="Next chapter"
                                aria-keyshortcuts="Right"
                            >
                                <i class="fa fa-angle-right"></i>
                            </a>

                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>

                <nav
                    class="nav-wide-wrapper"
                    aria-label="Page navigation"
                >
                    <a
                        rel="prev"
                        href="query_methods.html"
                        class="nav-chapters previous"
                        title="Previous chapter"
                        aria-label="Previous chapter"
                        aria-keyshortcuts="Left"
                    >
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a
                        rel="next prefetch"
                        href="candid.html"
                        class="nav-chapters next"
                        title="Next chapter"
                        aria-label="Next chapter"
                        aria-keyshortcuts="Right"
                    >
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>

            <script>
                window.playground_copyable = true;
            </script>

            <script src="elasticlunr.min.js"></script>
            <script src="mark.min.js"></script>
            <script src="searcher.js"></script>

            <script src="clipboard.min.js"></script>
            <script src="highlight.js"></script>
            <script src="book.js"></script>

            <!-- Custom JS scripts -->
        </div>
    </body>
</html>
