<!DOCTYPE html>
<html
    lang="en"
    class="light sidebar-visible"
    dir="ltr"
>
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8" />
        <title>@onLowWasmMemory - The Azle Book</title>

        <!-- Custom HTML head -->

        <meta
            name="description"
            content=""
        />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />
        <meta
            name="theme-color"
            content="#ffffff"
        />

        <link
            rel="icon"
            href="../../favicon.svg"
        />
        <link
            rel="shortcut icon"
            href="../../favicon.png"
        />
        <link
            rel="stylesheet"
            href="../../css/variables.css"
        />
        <link
            rel="stylesheet"
            href="../../css/general.css"
        />
        <link
            rel="stylesheet"
            href="../../css/chrome.css"
        />
        <link
            rel="stylesheet"
            href="../../css/print.css"
            media="print"
        />

        <!-- Fonts -->
        <link
            rel="stylesheet"
            href="../../FontAwesome/css/font-awesome.css"
        />
        <link
            rel="stylesheet"
            href="../../fonts/fonts.css"
        />

        <!-- Highlight.js Stylesheets -->
        <link
            rel="stylesheet"
            id="highlight-css"
            href="../../highlight.css"
        />
        <link
            rel="stylesheet"
            id="tomorrow-night-css"
            href="../../tomorrow-night.css"
        />
        <link
            rel="stylesheet"
            id="ayu-highlight-css"
            href="../../ayu-highlight.css"
        />

        <!-- Custom theme stylesheets -->

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = '../../';
            var default_theme = window.matchMedia(
                '(prefers-color-scheme: dark)'
            ).matches
                ? 'navy'
                : 'light';
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
        <div id="body-container">
            <!-- Work around some values being stored in localStorage wrapped in quotes -->
            <script>
                try {
                    var theme = localStorage.getItem('mdbook-theme');
                    var sidebar = localStorage.getItem('mdbook-sidebar');

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            'mdbook-theme',
                            theme.slice(1, theme.length - 1)
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            'mdbook-sidebar',
                            sidebar.slice(1, sidebar.length - 1)
                        );
                    }
                } catch (e) {}
            </script>

            <!-- Set the theme before any content is loaded, prevents flash -->
            <script>
                var theme;
                try {
                    theme = localStorage.getItem('mdbook-theme');
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                const html = document.documentElement;
                html.classList.remove('light');
                html.classList.add(theme);
                html.classList.add('js');
            </script>

            <input
                type="checkbox"
                id="sidebar-toggle-anchor"
                class="hidden"
            />

            <!-- Hide / unhide sidebar before it is displayed -->
            <script>
                var sidebar = null;
                var sidebar_toggle = document.getElementById(
                    'sidebar-toggle-anchor'
                );
                if (document.body.clientWidth >= 1080) {
                    try {
                        sidebar = localStorage.getItem('mdbook-sidebar');
                    } catch (e) {}
                    sidebar = sidebar || 'visible';
                } else {
                    sidebar = 'hidden';
                }
                sidebar_toggle.checked = sidebar === 'visible';
                html.classList.remove('sidebar-visible');
                html.classList.add('sidebar-' + sidebar);
            </script>

            <nav
                id="sidebar"
                class="sidebar"
                aria-label="Table of contents"
            >
                <!-- populated by js -->
                <mdbook-sidebar-scrollbox
                    class="sidebar-scrollbox"
                ></mdbook-sidebar-scrollbox>
                <noscript>
                    <iframe
                        class="sidebar-iframe-outer"
                        src="../../toc.html"
                    ></iframe>
                </noscript>
                <div
                    id="sidebar-resize-handle"
                    class="sidebar-resize-handle"
                >
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <div
                id="page-wrapper"
                class="page-wrapper"
            >
                <div class="page">
                    <div id="menu-bar-hover-placeholder"></div>
                    <div
                        id="menu-bar"
                        class="menu-bar sticky"
                    >
                        <div class="left-buttons">
                            <label
                                id="sidebar-toggle"
                                class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar"
                            >
                                <i class="fa fa-bars"></i>
                            </label>
                            <button
                                id="theme-toggle"
                                class="icon-button"
                                type="button"
                                title="Change theme"
                                aria-label="Change theme"
                                aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list"
                            >
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul
                                id="theme-list"
                                class="theme-popup"
                                aria-label="Themes"
                                role="menu"
                            >
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="light"
                                    >
                                        Light
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="rust"
                                    >
                                        Rust
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="coal"
                                    >
                                        Coal
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="navy"
                                    >
                                        Navy
                                    </button>
                                </li>
                                <li role="none">
                                    <button
                                        role="menuitem"
                                        class="theme"
                                        id="ayu"
                                    >
                                        Ayu
                                    </button>
                                </li>
                            </ul>
                            <button
                                id="search-toggle"
                                class="icon-button"
                                type="button"
                                title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false"
                                aria-keyshortcuts="S"
                                aria-controls="searchbar"
                            >
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                        <h1 class="menu-title">The Azle Book</h1>

                        <div class="right-buttons">
                            <a
                                href="../../print.html"
                                title="Print this book"
                                aria-label="Print this book"
                            >
                                <i
                                    id="print-button"
                                    class="fa fa-print"
                                ></i>
                            </a>
                        </div>
                    </div>

                    <div
                        id="search-wrapper"
                        class="hidden"
                    >
                        <form
                            id="searchbar-outer"
                            class="searchbar-outer"
                        >
                            <input
                                type="search"
                                id="searchbar"
                                name="searchbar"
                                placeholder="Search this book ..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header"
                            />
                        </form>
                        <div
                            id="searchresults-outer"
                            class="searchresults-outer hidden"
                        >
                            <div
                                id="searchresults-header"
                                class="searchresults-header"
                            ></div>
                            <ul id="searchresults"></ul>
                        </div>
                    </div>

                    <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                    <script>
                        document
                            .getElementById('sidebar-toggle')
                            .setAttribute(
                                'aria-expanded',
                                sidebar === 'visible'
                            );
                        document
                            .getElementById('sidebar')
                            .setAttribute('aria-hidden', sidebar !== 'visible');
                        Array.from(
                            document.querySelectorAll('#sidebar a')
                        ).forEach(function (link) {
                            link.setAttribute(
                                'tabIndex',
                                sidebar === 'visible' ? 0 : -1
                            );
                        });
                    </script>

                    <div
                        id="content"
                        class="content"
                    >
                        <main>
                            <h1 id="onlowwasmmemory">
                                <a
                                    class="header"
                                    href="#onlowwasmmemory"
                                    >@onLowWasmMemory</a
                                >
                            </h1>
                            <p>
                                The <code>@onLowWasmMemory</code> decorator
                                marks a method as the low Wasm memory handler
                                for your canister. This system method is
                                automatically called when your canister is
                                running low on Wasm memory, allowing you to
                                implement graceful memory management.
                            </p>
                            <h2 id="usage">
                                <a
                                    class="header"
                                    href="#usage"
                                    >Usage</a
                                >
                            </h2>
                            <pre><code class="language-typescript">import { onLowWasmMemory } from 'azle';

export default class {
    cache: Map&lt;string, any&gt; = new Map();

    @onLowWasmMemory
    handleLowMemory(): void {
        // Clean up unnecessary data
        this.cache.clear();

        // Log the event
        console.info('Low memory condition detected, cleaned up cache');

        // Perform additional cleanup
        this.performMemoryCleanup();
    }

    private performMemoryCleanup(): void {
        // Custom cleanup logic
        // Remove old entries, compact data structures, etc.
    }
}
</code></pre>
                            <h2 id="characteristics">
                                <a
                                    class="header"
                                    href="#characteristics"
                                    >Characteristics</a
                                >
                            </h2>
                            <ul>
                                <li>
                                    <strong>State Access</strong>: Read-write
                                </li>
                                <li>
                                    <strong>Replication</strong>: Yes
                                    (replicated across all nodes)
                                </li>
                                <li>
                                    <strong>Async Support</strong>: Yes, can be
                                    async
                                </li>
                                <li>
                                    <strong>Instruction Limit</strong>:
                                    40,000,000,000 instructions
                                </li>
                                <li>
                                    <strong>Frequency</strong>: Called
                                    automatically when memory is low
                                </li>
                                <li>
                                    <strong>Limit</strong>: Only one
                                    <code>@onLowWasmMemory</code> method per
                                    canister
                                </li>
                            </ul>
                            <h2 id="common-use-cases">
                                <a
                                    class="header"
                                    href="#common-use-cases"
                                    >Common Use Cases</a
                                >
                            </h2>
                            <h3 id="cache-management">
                                <a
                                    class="header"
                                    href="#cache-management"
                                    >Cache Management</a
                                >
                            </h3>
                            <pre><code class="language-typescript">import { onLowWasmMemory, query, update, IDL } from 'azle';

export default class {
    cache: Map&lt;string, { data: any; timestamp: bigint }&gt; = new Map();
    userData: Map&lt;string, any&gt; = new Map();

    @onLowWasmMemory
    handleLowMemory(): void {
        // Clear expired cache entries
        const currentTime = Date.now();
        const oneHourAgo = BigInt(currentTime - 3600000);

        for (const [key, value] of this.cache.entries()) {
            if (value.timestamp &lt; oneHourAgo) {
                this.cache.delete(key);
            }
        }

        console.info(`Cleaned up cache, ${this.cache.size} entries remaining`);
    }

    @update([IDL.Text, IDL.Text], IDL.Bool)
    cacheData(key: string, data: string): boolean {
        this.cache.set(key, {
            data,
            timestamp: BigInt(Date.now())
        });
        return true;
    }

    @query([IDL.Text], IDL.Opt(IDL.Text))
    getCachedData(key: string): string | undefined {
        return this.cache.get(key)?.data;
    }
}
</code></pre>
                            <h3 id="data-structure-optimization">
                                <a
                                    class="header"
                                    href="#data-structure-optimization"
                                    >Data Structure Optimization</a
                                >
                            </h3>
                            <pre><code class="language-typescript">import { onLowWasmMemory, StableBTreeMap } from 'azle';

export default class {
    tempData: any[] = [];
    stableStorage = new StableBTreeMap&lt;string, string&gt;(0);

    @onLowWasmMemory
    async handleLowMemory(): Promise&lt;void&gt; {
        // Move temporary data to stable storage
        for (let i = 0; i &lt; this.tempData.length; i++) {
            const item = this.tempData[i];
            if (item.shouldPersist) {
                this.stableStorage.insert(item.id, JSON.stringify(item));
            }
        }

        // Clear temporary arrays
        this.tempData = [];

        console.info('Moved temporary data to stable storage');
    }
}
</code></pre>
                            <h3 id="memory-monitoring">
                                <a
                                    class="header"
                                    href="#memory-monitoring"
                                    >Memory Monitoring</a
                                >
                            </h3>
                            <pre><code class="language-typescript">import { onLowWasmMemory, canisterCycleBalance, time } from 'azle';

export default class {
    memoryEvents: { timestamp: bigint; action: string }[] = [];

    @onLowWasmMemory
    handleLowMemory(): void {
        const timestamp = time();
        const cycleBalance = canisterCycleBalance();

        // Log the memory event
        this.memoryEvents.push({
            timestamp,
            action: `Low memory detected. Cycle balance: ${cycleBalance}`
        });

        // Keep only recent events (last 100)
        if (this.memoryEvents.length &gt; 100) {
            this.memoryEvents = this.memoryEvents.slice(-100);
        }

        // Perform cleanup based on available cycles
        if (cycleBalance &lt; 1_000_000_000n) {
            // Aggressive cleanup if cycles are also low
            this.performAggressiveCleanup();
        } else {
            // Standard cleanup
            this.performStandardCleanup();
        }
    }

    private performAggressiveCleanup(): void {
        // More aggressive memory management
    }

    private performStandardCleanup(): void {
        // Standard memory management
    }
}
</code></pre>
                            <h2 id="best-practices">
                                <a
                                    class="header"
                                    href="#best-practices"
                                    >Best Practices</a
                                >
                            </h2>
                            <ol>
                                <li>
                                    <strong>Keep It Simple</strong>: The low
                                    memory handler should be efficient and avoid
                                    complex operations
                                </li>
                                <li>
                                    <strong>Prioritize Cleanup</strong>: Focus
                                    on freeing memory rather than performing
                                    business logic
                                </li>
                                <li>
                                    <strong>Log Events</strong>: Track when low
                                    memory events occur for monitoring
                                </li>
                                <li>
                                    <strong>Consider Cycles</strong>: Check
                                    cycle balance as low memory often correlates
                                    with resource constraints
                                </li>
                                <li>
                                    <strong>Test Thoroughly</strong>: Simulate
                                    low memory conditions to ensure your handler
                                    works correctly
                                </li>
                            </ol>
                            <h2 id="important-notes">
                                <a
                                    class="header"
                                    href="#important-notes"
                                    >Important Notes</a
                                >
                            </h2>
                            <ul>
                                <li>
                                    This decorator is automatically triggered by
                                    the IC when memory is low
                                </li>
                                <li>
                                    Only one method per canister can have this
                                    decorator
                                </li>
                                <li>
                                    The method should complete quickly to avoid
                                    blocking the canister
                                </li>
                                <li>
                                    Consider the instruction limit when
                                    implementing complex cleanup logic
                                </li>
                                <li>
                                    This is a system-level method that doesn't
                                    appear in your Candid interface
                                </li>
                            </ul>
                        </main>

                        <nav
                            class="nav-wrapper"
                            aria-label="Page navigation"
                        >
                            <!-- Mobile navigation buttons -->
                            <a
                                rel="prev"
                                href="../../candid_rpc/decorators/heartbeat.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left"
                            >
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a
                                rel="next prefetch"
                                href="../../candid_rpc/ic_api.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter"
                                aria-label="Next chapter"
                                aria-keyshortcuts="Right"
                            >
                                <i class="fa fa-angle-right"></i>
                            </a>

                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>

                <nav
                    class="nav-wide-wrapper"
                    aria-label="Page navigation"
                >
                    <a
                        rel="prev"
                        href="../../candid_rpc/decorators/heartbeat.html"
                        class="nav-chapters previous"
                        title="Previous chapter"
                        aria-label="Previous chapter"
                        aria-keyshortcuts="Left"
                    >
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a
                        rel="next prefetch"
                        href="../../candid_rpc/ic_api.html"
                        class="nav-chapters next"
                        title="Next chapter"
                        aria-label="Next chapter"
                        aria-keyshortcuts="Right"
                    >
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>

            <script>
                window.playground_copyable = true;
            </script>

            <script src="../../elasticlunr.min.js"></script>
            <script src="../../mark.min.js"></script>
            <script src="../../searcher.js"></script>

            <script src="../../clipboard.min.js"></script>
            <script src="../../highlight.js"></script>
            <script src="../../book.js"></script>

            <!-- Custom JS scripts -->
        </div>
    </body>
</html>
