name: Auto Merge Dependabot PRs
on:
    pull_request:
        types:
            - opened
            - synchronize
            - reopened

jobs:
    check-conditions:
        runs-on: ubuntu-latest
        steps:
            - run: echo "${{ github.actor }}"
            - run: echo "${{ github.event.pull_request.labels.*.name }}"
            - run: echo "${{ github.actor == 'dependabot[bot]' }}"
            - run: echo "${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}"

    auto-merge:
        if: ${{ github.actor == 'dependabot[bot]' && contains(github.event.pull_request.labels.*.name, 'dependencies') }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  token: ${{ secrets.LASTMJS_GITHUB_TOKEN }}

            - name: Approve PR
              run: gh pr review --approve "$PR_NUMBER"
              env:
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  GITHUB_TOKEN: ${{ secrets.LASTMJS_GITHUB_TOKEN }}

            - name: Merge PR
              run: |
                  gh pr merge "$PR_NUMBER" \
                      --merge \
                      --auto
              env:
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  GITHUB_TOKEN: ${{ secrets.LASTMJS_GITHUB_TOKEN }}
