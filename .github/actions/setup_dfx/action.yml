name: Setup dfx
description: 'Sets up dfx by detecting version from package.json and installing it. (Note: DFX must be installed before `npm install` because the azle installation process requires dfx)'
inputs:
    working-directory:
        description: 'Directory containing package.json (defaults to current directory)'
        required: false
        default: '.'
outputs:
    dfx-version:
        description: 'The version of dfx that was installed'
        value: ${{ steps.get-dfx-version.outputs.dfx-version }}
runs:
    using: composite
    steps:
        - id: get-dfx-version
          run: |
              PACKAGE_JSON_PATH="${{ inputs.working-directory }}/package.json"
              DFX_VERSION=$(jq -r '.azle.globalDependencies.dfx // error("dfx version not found")' "$PACKAGE_JSON_PATH")
              echo "dfx-version=${DFX_VERSION}" >> "$GITHUB_OUTPUT"
          shell: bash

        # Install dfx (Note: dfx must be installed before `npx azle` because the azle installation process requires dfx)
        - name: Install dfx
          uses: ${{ inputs.working-directory }}/.github/actions/retry_command
          with:
              working-directory: '${{ inputs.working-directory }}'
              command: src/stable/build/commands/dev/setup/install_dfx.sh "${{ steps.get-dfx-version.outputs.dfx-version }}"

        - run: echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH
          shell: bash
